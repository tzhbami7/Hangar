<!--
noVNC example: simple example using default UI
Copyright (C) 2012 Joel Martin
Copyright (C) 2013 Samuel Mannehed for Cendio AB
noVNC is licensed under the MPL 2.0 (see LICENSE.txt)
This file is licensed under the 2-Clause BSD license (see LICENSE.txt).

Connect parameters are provided in query string:
    http://example.com/?host=HOST&port=PORT&encrypt=1&true_color=1
or the fragment:
    http://example.com/#host=HOST&port=PORT&encrypt=1&true_color=1
-->

{% extends "layout.html" %}
{% block title %}Overview{% endblock %}
{% block content %}
  <div class="col-md-10 col-md-offset-2">
    <div class="row">

      <div class="col-md-12" style="background-color: #E0E0E0; height: 72px;">
        <ol class="breadcrumb breadcrumb-md">
          <li class="active">Overview</li>
        </ol>
      </div>

      <div class="col-md-12">
        {{ super() }}
        {{ ip }}
      </div>

      <div class="col-md-8 col-md-offset-1">
        <div class="page-header page-header-md">
          <h4>SSH</h4>
        </div>
        <div class="panel panel-default">
          <!-- <div class="panel-heading">
            <h3 class="panel-title">Panel title</h3>
          </div> -->
          <div class="panel-body">
            <div id="noVNC_screen">
              <div id="noVNC_status_bar" class="noVNC_status_bar" style="margin-top: 0px;">
                <table border=0 width="100%">
                  <tr>
                    <td>
                      <div id="noVNC_status" style="position: relative; height: auto;">
                        Loading
                      </div>
                    </td>
                    <td width="1%">
                      <div id="noVNC_buttons">
                        <input type=button value="Send CtrlAltDel" id="sendCtrlAltDelButton">
                        <span id="noVNC_xvp_buttons">
                          <input type=button value="Shutdown" id="xvpShutdownButton">
                          <input type=button value="Reboot" id="xvpRebootButton">
                          <input type=button value="Reset" id="xvpResetButton">
                        </span>
                      </div>
                    </td>
                  </tr>
                </table>
              </div>
              <canvas id="noVNC_canvas" width="640px" height="20px">
                Canvas not supported.
              </canvas>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
{% endblock %}

{% block script %}
  <script src="{{ url_for('static', filename='js/noVNC/util.js') }}"></script>
  <script>
    /*jslint white: false */
    /*global window, $, Util, RFB, */
    "use strict";

    // Load supporting scripts
    var INCLUDE_URI = "{{ url_for('static', filename='js/noVNC/') }}";
    Util.load_scripts(["webutil.js", "base64.js", "websock.js", "des.js",
                       "keysymdef.js", "keyboard.js", "input.js", "display.js",
                       "inflator.js", "rfb.js", "keysym.js"]);

    var rfb;
    var resizeTimeout;


    function UIresize() {
        if (WebUtil.getConfigVar('resize', false)) {
            var innerW = window.innerWidth;
            var innerH = window.innerHeight;
            var controlbarH = $D('noVNC_status_bar').offsetHeight;
            var padding = 5;
            if (innerW !== undefined && innerH !== undefined)
                rfb.setDesktopSize(innerW, innerH - controlbarH - padding);
        }
    }
    function FBUComplete(rfb, fbu) {
        UIresize();
        rfb.set_onFBUComplete(function() { });
    }
    function passwordRequired(rfb) {
        var msg;
        msg = '<form onsubmit="return setPassword();"';
        msg += '  style="margin-bottom: 0px">';
        msg += 'Password Required: ';
        msg += '<input type=password size=10 id="password_input" class="noVNC_status">';
        msg += '<\/form>';
        $D('noVNC_status_bar').setAttribute("class", "noVNC_status_warn");
        $D('noVNC_status').innerHTML = msg;
    }
    function setPassword() {
        rfb.sendPassword($D('password_input').value);
        return false;
    }
    function sendCtrlAltDel() {
        rfb.sendCtrlAltDel();
        return false;
    }
    function xvpShutdown() {
        rfb.xvpShutdown();
        return false;
    }
    function xvpReboot() {
        rfb.xvpReboot();
        return false;
    }
    function xvpReset() {
        rfb.xvpReset();
        return false;
    }
    function updateState(rfb, state, oldstate, msg) {
        var s, sb, cad, level;
        s = $D('noVNC_status');
        sb = $D('noVNC_status_bar');
        cad = $D('sendCtrlAltDelButton');
        switch (state) {
            case 'failed':       level = "error";  break;
            case 'fatal':        level = "error";  break;
            case 'normal':       level = "normal"; break;
            case 'disconnected': level = "normal"; break;
            case 'loaded':       level = "normal"; break;
            default:             level = "warn";   break;
        }

        if (state === "normal") {
            cad.disabled = false;
        } else {
            cad.disabled = true;
            xvpInit(0);
        }

        if (typeof(msg) !== 'undefined') {
            sb.setAttribute("class", "noVNC_status_" + level);
            s.innerHTML = msg;
        }
    }

    window.onresize = function () {
        // When the window has been resized, wait until the size remains
        // the same for 0.5 seconds before sending the request for changing
        // the resolution of the session
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(function(){
            UIresize();
        }, 500);
    };

    function xvpInit(ver) {
        var xvpbuttons;
        xvpbuttons = $D('noVNC_xvp_buttons');
        if (ver >= 1) {
            xvpbuttons.style.display = 'inline';
        } else {
            xvpbuttons.style.display = 'none';
        }
    }

    window.onscriptsload = function () {
        var host, port, password, path, token;

        $D('sendCtrlAltDelButton').style.display = "inline";
        $D('sendCtrlAltDelButton').onclick = sendCtrlAltDel;
        $D('xvpShutdownButton').onclick = xvpShutdown;
        $D('xvpRebootButton').onclick = xvpReboot;
        $D('xvpResetButton').onclick = xvpReset;

        WebUtil.init_logging(WebUtil.getConfigVar('logging', 'warn'));
        document.title = unescape(WebUtil.getConfigVar('title', 'noVNC'));
        // By default, use the host and port of server that served this file
        // host = WebUtil.getConfigVar('host', window.location.hostname);
        host = WebUtil.getConfigVar('host', "localhost");
        console.log("{{ip}}");
        // port = WebUtil.getConfigVar('port', window.location.port);
        port = WebUtil.getConfigVar('port', 5800);

        // if port == 80 (or 443) then it won't be present and should be
        // set manually
        if (!port) {
            if (window.location.protocol.substring(0,5) == 'https') {
                port = 443;
            }
            else if (window.location.protocol.substring(0,4) == 'http') {
                port = 80;
            }
        }

        password = WebUtil.getConfigVar('password', '');
        path = WebUtil.getConfigVar('path', 'websockify');
        // path = ''
        console.log("a: " + path);
        // If a token variable is passed in, set the parameter in a cookie.
        // This is used by nova-novncproxy.
        token = WebUtil.getConfigVar('token', null);
        if (token) {

            // if token is already present in the path we should use it
            path = WebUtil.injectParamIfMissing(path, "token", token);

            WebUtil.createCookie('token', token, 1)
        }

        if ((!host) || (!port)) {
            updateState(null, 'fatal', null, 'Must specify host and port in URL');
            return;
        }

        try {
            rfb = new RFB({'target':       $D('noVNC_canvas'),
                           'encrypt':      false,
                           'true_color':   true,
                           'local_cursor': true,
                           'shared':       true,
                           'view_only':    false,
                           'onUpdateState':  updateState,
                           'onXvpInit':    xvpInit,
                           'onFBUComplete': FBUComplete});
        } catch (exc) {
            updateState(null, 'fatal', null, 'Unable to create RFB client -- ' + exc);
            return; // don't continue trying to connect
        }

        rfb.connect(host, port, password, path);
    };
  </script>
{% endblock %}
